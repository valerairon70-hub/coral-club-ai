# Архитектура — Coral Club AI-ассистент

## Схема системы

```
┌─────────────────────────────────────────────────────────────┐
│              Веб-интерфейс (HTML + CSS + JS)                 │
│                                                             │
│  [Загрузить скриншот диаграммы]  [Ввести 3 жалобы клиента]  │
│                          ↓                                  │
│              [Получить расшифровку]                         │
└─────────────────────────────┬───────────────────────────────┘
                              │  fetch POST /api/analyze
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              api/analyze.js (Vercel Serverless)             │
│                                                             │
│  1. Принимает изображение диаграммы + текст жалоб           │
│  2. Читает API-ключ из переменных окружения (безопасно)     │
│  3. Формирует запрос к Claude API                           │
│  4. Возвращает структурированный ответ                      │
│  5. Обрабатывает ошибки перед отправкой клиенту             │
└─────────────────────────────┬───────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼                           ▼
┌───────────────────────┐     ┌─────────────────────────────┐
│    Claude API          │     │      База знаний (JSON)      │
│  (claude-opus-4-6)     │     │                             │
│                       │     │  - 12 систем организма      │
│  Vision:              │     │  - ~200 продуктов Coral Club │
│  читает диаграмму     │◄────│  - Протоколы Бутаковой      │
│                       │     │  - Причинно-следственные     │
│  Системный промпт:    │     │    связи (система → симптомы)│
│  роль эксперта        │     └─────────────────────────────┘
└───────────────────────┘
```

---

## Безопасность API-ключа

**Проблема:** API-ключ Claude нельзя хранить в HTML или JS-файлах — он виден любому в браузере.

**Решение:** Vercel Serverless Function
- Ключ хранится в переменных окружения Vercel (`ANTHROPIC_API_KEY`)
- Фронтенд отправляет запрос на `/api/analyze` — свою серверную функцию
- Функция использует ключ на сервере и передаёт результат обратно
- Ключ никогда не покидает сервер

---

## Модули системы

### 1. Интерпретатор диаграммы (Vision)
**Задача:** прочитать скриншот трекера и извлечь статусы систем

**Входные данные:**
- Изображение диаграммы (скриншот из приложения трекера)

**Выходные данные:**
```json
{
  "systems": [
    { "name": "Пищеварительная система", "status": "overload" },
    { "name": "Сердечно-сосудистая система", "status": "load" },
    { "name": "Иммунная система", "status": "normal" }
  ]
}
```

**Статусы:**
- `normal` — норма
- `load` — работает под нагрузкой
- `overload` — перегруз

---

### 2. База знаний

#### 2.1 Описание 12 систем организма
```
Для каждой системы хранится:
- Название
- Функции простым языком
- Типичные симптомы при нагрузке
- Типичные симптомы при перегрузе
- Связанные системы (межсистемные зависимости)
```

#### 2.2 Каталог продуктов Coral Club
```
Для каждого продукта:
- Название
- Состав (ключевые компоненты)
- Механизм действия (простым языком)
- Показания (какие системы поддерживает)
- Протоколы применения
```

#### 2.3 Протоколы Бутаковой
```
Маппинг:
  система + статус → список продуктов + схема приёма
```

---

### 3. Генератор консультации

**Входные данные:**
- Статусы систем (из интерпретатора)
- 3 жалобы клиента (текст)
- Данные из базы знаний

**Выходные данные:**
- Расшифровка диаграммы
- Причинно-следственная цепочка
- Протокол на продуктах
- Скрипт консультации

---

### 4. Обработка ошибок

| Ситуация | HTTP-код | Что видит пользователь |
|----------|----------|------------------------|
| Файл не является изображением | 400 | «Загрузите изображение (JPG, PNG)» |
| Изображение не диаграмма трекера | 422 | «Не могу прочитать диаграмму. Попробуйте другой скриншот» |
| Файл слишком большой (>5 МБ) | 413 | «Файл слишком большой. Максимум — 5 МБ» |
| Ошибка Claude API (5xx) | 502 | «Сервис временно недоступен. Попробуйте через минуту» |
| Нет интернета (на стороне клиента) | — | «Проверьте подключение к интернету» |
| Превышен лимит тарифа | 429 | «Лимит анализов исчерпан. Осталось X дней до обновления» |

**Принцип:** пользователь всегда видит понятное сообщение — никаких технических кодов в интерфейсе.

---

## Системный промпт (концепция)

```
Ты — опытный нутрициолог и суплементолог с 20-летним практическим опытом,
специализирующийся на продуктах Coral Club и методике Бутаковой.

Твоя задача — помочь дистрибьютору подготовить консультацию для клиента.

Принципы:
1. Говори простым человеческим языком — без медицинских терминов
2. Строй причинно-следственные связи: система → симптом → решение
3. Фокусируйся на том, что беспокоит клиента прямо сейчас
4. Показывай заботу и внимание к конкретному человеку
5. Не ставь диагнозы, не заходи на медицинскую территорию
6. При серьёзных перегрузах — мягко рекомендуй профильного врача

Формат ответа: [структурированный вывод для консультации]
```

---

## Структура проекта

```
my-first-idea/
├── PROJECT.md              # Документация проекта
├── ARCHITECTURE.md         # Этот файл
├── PLAN.md                 # План разработки
├── CLAUDE.md               # Правила работы с проектом
│
├── index.html              # Лендинг (маркетинг)
├── pricing.html            # Страница тарифов
│
├── app/                    # Рабочий AI-инструмент (Фаза 1)
│   └── index.html          # Страница анализа диаграммы
│
├── api/                    # Серверные функции Vercel
│   └── analyze.js          # Прокси к Claude API (хранит ключ безопасно)
│
└── knowledge/              # База знаний (JSON-файлы)
    ├── systems.json        # 12 систем организма
    ├── products.json       # Продукты Coral Club
    └── protocols.json      # Протоколы Бутаковой
```

---

## Зависимости

```json
{
  "@anthropic-ai/sdk": "latest"
}
```

> Только один пакет — для работы с Claude API на сервере. Весь фронтенд — без зависимостей.

---

## Следующие шаги

1. Получить инструкцию трекера → наполнить `systems.json`
2. Получить пример скриншота → протестировать vision-чтение диаграммы
3. Получить каталог продуктов → наполнить `products.json` и `protocols.json`
4. Написать и протестировать системный промпт
5. Собрать страницу анализа (`app/index.html`)
6. Написать серверную функцию `api/analyze.js`
7. Задеплоить на Vercel, добавить API-ключ в переменные окружения
